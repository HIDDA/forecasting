---
title: "Forecasting Swiss ILI counts"
author: "Sebastian Meyer"
date: "`r Sys.Date()`"
output:
    rmarkdown::html_vignette:
        fig_width: 7
        fig_height: 4
vignette: >
  %\VignetteIndexEntry{Forecasting Swiss ILI counts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{ggplot2, surveillance, car, forecast, prophet}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, error = FALSE)
```


## Swiss ILI surveillance counts

```{r}
library("HIDDA.forecasting")
library("zoo")
library("ggplot2")

## define start times of 30-week-ahead test periods
T <- match(paste0(2013:2015, "-12"), strftime(index(CHILI), "%Y-%m"))
index(CHILI)[T]
TEST <- lapply(T, function (T) seq(from = T, by = 1, length.out = 30))
TRAIN <- lapply(TEST, function (test) 1:(test[1]-1))
OWA <- (T[1]:length(CHILI)) - 1  # one-week-ahead forecasts at these time points
length(OWA)
```

```{r CHILI}
autoplot(CHILI) +
    labs(x = "Time (week)", y = "ILI counts in Switzerland (projected)") +
    geom_vline(xintercept = index(CHILI)[min(unlist(TEST))], lty = 2) +
    geom_rect(aes(xmin=xmin, xmax=xmax, ymin=-Inf, ymax=Inf),
              data=data.frame(xmin=index(CHILI)[sapply(TEST, min)],
                              xmax=index(CHILI)[sapply(TEST, max)]),
              inherit.aes=FALSE, alpha=0.3)
```


### Seasonality

```{r CHILIdat}
CHILIdat <- within(fortify(CHILI), {
    Year = as.factor(strftime(Index, "%Y"))
    DayInYear = as.integer(strftime(Index, "%j"))
    WeekInYear = as.integer(strftime(Index, "%V"))
})
```

```{r seasonality}
## ggplot(CHILIdat, aes(x = DayInYear, y = CHILI, col = Year)) + geom_line()
ggplot(CHILIdat, aes(x = WeekInYear, y = CHILI, col = Year)) + geom_line() +
    scale_y_sqrt() + guides(col = guide_legend(ncol = 2)) #+ theme(legend.position = "bottom")
```


## Modelling

```{r}
## in the following we use the first forecast period for illustration
TRAIN <- TRAIN[[1]]
TEST <- TEST[[1]]
```


### `surveillance::hhh4`

```{r}
library("surveillance")
CHILI.sts <- sts(observed = CHILI,
                 epoch = as.integer(index(CHILI)), epochAsDate = TRUE)
```

```{r hhh4fit}
(weeksInYear <- table(year(CHILI.sts)))
mean(weeksInYear)  # long-term average is 52.1775
f1 <- addSeason2formula(~ 1, period = 52.1775, timevar = "index")
## equivalent: f1 <- addSeason2formula(~ 1, period = 365.2425, timevar = "t")
hhh4fit <- hhh4(stsObj = CHILI.sts,
     control = list(
         ar = list(f = update(f1, ~. + christmas)),
         end = list(f = f1),
         family = "NegBin1", subset = TRAIN[-1],
         data = list(index = 1:nrow(CHILI.sts),
                     christmas = as.integer(epochInYear(CHILI.sts) %in% 52))
     ))
summary(hhh4fit, maxEV = TRUE)
```

Alternatively, use a yearly varying frequency of 52 or 53 weeks for
the sinusoidal time effects:

```{r hhh4fit_varfreq}
f1_varfreq <- ~ 1 + sin(2*pi*epochInYear/weeksInYear) + cos(2*pi*epochInYear/weeksInYear)
hhh4fit_varfreq <- update(hhh4fit,
    ar = list(f = update(f1_varfreq, ~. + christmas)),
    end = list(f = f1_varfreq),
    data = list(epochInYear = epochInYear(CHILI.sts),
                weeksInYear = rep(weeksInYear, weeksInYear)))
AIC(hhh4fit, hhh4fit_varfreq)
plot(hhh4fit, hhh4fit_varfreq, type = "maxEV",
     matplot.args = list(ylab = expression(lambda[t]), xlim =c(2002,2007)))
```

```{r hhh4fitted_decomposed}
plot(hhh4fit, pch = 20, names = "", ylab = "")
```

```{r hhh4fitted_lambdat}
qplot(x = 1:53, y = predict(hhh4fit, newSubset = 1:53, type="ar.exppred"),
      geom = "line", ylim = c(0,1.3), xlab = "week", ylab = expression(lambda[t])) +
    geom_hline(yintercept = 1, lty = 2)
```

```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$hhh4upper <- CHILIdat$hhh4lower <- CHILIdat$hhh4fitted <- NA_real_
CHILIdat[hhh4fit$control$subset,"hhh4fitted"] <- fitted(hhh4fit)
CHILIdat[hhh4fit$control$subset,c("hhh4lower","hhh4upper")] <-
    sapply(c(0.025, 0.975), function (p)
        qnbinom(p, mu = fitted(hhh4fit),
                size = exp(hhh4fit$coefficients[["-log(overdisp)"]])))
```

```{r hhh4fitted}
ggplot(CHILIdat, aes(x=Index, ymin=hhh4lower, y=hhh4fitted, ymax=hhh4upper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) + scale_y_sqrt()
```


### `forecast::auto.arima`

```{r boxcox}
car::powerTransform(CHILI)  # -> log transformation
```

```{r arimafit}
library("forecast")
arimafit <- auto.arima(log1p(CHILI[TRAIN]), stepwise=FALSE, approximation=FALSE)
summary(arimafit)
```

CAVE: Seasonality cannot be taken into account in the standard way because the
data have no regular frequency (not a standard `"ts"`) ...
But we can add sine/cosine covariates just like in the endemic part of the above
`hhh4` model.

```{r sarimafit}
sarimafit <- auto.arima(log1p(CHILI[TRAIN]), stepwise=FALSE, approximation=FALSE,
    xreg = t(sapply(2*pi*TRAIN/52.1775, function (x) c(sin=sin(x), cos=cos(x)))))
summary(sarimafit)
```

```{r sarimaxfit}
sarimax_cov <- cbind(
    t(sapply(2*pi*seq_along(CHILI)/52.1775, function (x) c(sin=sin(x), cos=cos(x)))),
    christmas = as.integer(strftime(index(CHILI), "%V") == "52")
)
sarimaxfit <- auto.arima(log1p(CHILI[TRAIN]), stepwise=FALSE, approximation=FALSE,
                         xreg = sarimax_cov[TRAIN,])
summary(sarimaxfit)
```


```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$sarimaxupper <- CHILIdat$sarimaxlower <- CHILIdat$sarimaxfitted <- NA_real_
CHILIdat[TRAIN,"sarimaxfitted"] <- expm1(fitted(sarimaxfit))
CHILIdat[TRAIN,c("sarimaxlower","sarimaxupper")] <-
    sapply(c(0.025, 0.975), function (p)
        expm1(fitted(sarimaxfit) + qnorm(p, sd=sqrt(sarimaxfit$sigma2))))
```

```{r sarimaxfitted}
ggplot(CHILIdat, aes(x=Index, ymin=sarimaxlower, y=sarimaxfitted, ymax=sarimaxupper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) + scale_y_sqrt()
```


### `prophet::prophet`

```{r prophetfit}
library("prophet")
prophetfit <- prophet(data.frame(ds = index(CHILI), y = log1p(CHILI))[TRAIN,],
                      yearly.seasonality = TRUE,
                      weekly.seasonality = FALSE, daily.seasonality = FALSE,
                      holidays = data.frame(
                          holiday = "Christmas",
                          ds = as.Date(paste0(2000:2016, "-12-24")),
                          lower_window = 0,
                          upper_window = 7
                      ))
prophetfitted <- predict(prophetfit)
```

```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$prophetupper <- CHILIdat$prophetlower <- CHILIdat$prophetfitted <- NA_real_
CHILIdat[TRAIN,c("prophetfitted","prophetlower","prophetupper")] <-
    expm1(prophetfitted[c("yhat", "yhat_lower", "yhat_upper")])
```

```{r prophetfitted}
##plot(prophetfit, prophetfitted)
ggplot(CHILIdat, aes(x=Index, ymin=prophetlower, y=prophetfitted, ymax=prophetupper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) + scale_y_sqrt()
```


### kcde? tsiR? random forests?



## One-week-ahead forecasts

### `hhh4`

```{r hhh4owa}
## fix: we should not need to refit to the whole time range
hhh4fitall <- update(hhh4fit, subset = 2:nrow(hhh4fit$stsObj))
hhh4owa <- oneStepAhead(hhh4fitall, range(OWA), verbose = FALSE)
```

```{r hhh4owa_pit}
pit(hhh4owa)
```

```{r hhh4owa_caltest}
calibrationTest(hhh4owa, which = "dss")
```

```{r hhh4owa_scores}
hhh4owa_scores <- scores(hhh4owa, which = "dss")
summary(hhh4owa_scores)
```

```{r hhh4owa_plot}
library("fanplot")
probs <- seq(0.01, 0.99, 0.01)
quantiles <- t(sapply(probs, qnbinom, mu = hhh4owa$pred, size = exp(hhh4owa$psi)))
layout(cbind(1:2), heights=c(2,1))
par(mar=c(0,5,1,1))
plot(c(1,length(OWA)), c(0,1.5*max(CHILI[OWA+1])), type="n", xaxt="n", xlab="", ylab="Counts")
fan(quantiles, data.type="values", probs = probs,
    ln = NULL, fan.col = colorRampPalette(c("darkgreen", "gray90")))
points(seq_along(OWA), CHILI[OWA+1], pch=20)
par(mar=c(5,5,0,1))
plot(seq_along(OWA), hhh4owa_scores, type="l", ylab = "DSS", xlab = "Week")
```


### `Arima`

```{r, eval = FALSE}
sarimax_order <- sarimaxfit$arma[c(1, 6, 2, 3, 7, 4, 5)]
sarimaxowa <- t(sapply(OWA, function (t) {
    cat("t =", t, "...\n")
    sarimaxfit_t <- Arima(log1p(CHILI[1:t]),
                          order = sarimax_order[1:3],
                          seasonal = list(order = sarimax_order[4:6], period = sarimax_order[7]),
                          xreg = sarimax_cov[1:t,,drop=FALSE])
    if (t == max(TRAIN)) # check that we are refitting the same model
        stopifnot(identical(fitted(sarimaxfit_t), fitted(sarimaxfit)))
    unlist(predict(sarimaxfit_t, nahead=1, newxreg=sarimax_cov[t+1,,drop=FALSE]))
}))
```


### `prophet`



## Long-term forecasts


### `hhh4`



### `Arima`

```{r}
plot(forecast(arimafit, h=length(TEST), fan=TRUE))
##predict(arimafit, n.ahead=length(TEST))
```


### `prophet`

```{r}
##future <- make_future_dataframe(prophetfit, periods = length(TEST), freq = "week", include_history = FALSE)
forecast <- predict(prophetfit, data.frame(ds = index(CHILI)[TEST]))
```
