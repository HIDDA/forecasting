---
title: "Forecasting Swiss ILI counts"
author: "Sebastian Meyer"
date: "`r Sys.Date()`"
output:
    rmarkdown::html_vignette:
        fig_width: 7
        fig_height: 4
        toc: TRUE
vignette: >
  %\VignetteIndexEntry{Forecasting Swiss ILI counts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{ggplot2, surveillance, fanplot, forecast, prophet}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, error = FALSE)
```


## Swiss ILI surveillance counts

```{r}
library("HIDDA.forecasting")
library("zoo")
library("ggplot2")

## define start times of 30-week-ahead test periods
T <- match(paste0(2013:2015, "-12"), strftime(index(CHILI), "%Y-%m"))
index(CHILI)[T]
TEST <- lapply(T, function (T) seq(from = T, by = 1, length.out = 30))
TRAIN <- lapply(TEST, function (test) 1:(test[1]-1))
OWA <- (T[1]:length(CHILI)) - 1  # one-week-ahead forecasts at these time points
length(OWA)
```

```{r CHILI}
autoplot(CHILI) +
    labs(x = "Time (week)", y = "ILI counts in Switzerland") +
    geom_vline(xintercept = index(CHILI)[min(unlist(TEST))], lty = 2) +
    geom_rect(aes(xmin=xmin, xmax=xmax, ymin=0, ymax=Inf),
              data=data.frame(xmin=index(CHILI)[sapply(TEST, min)],
                              xmax=index(CHILI)[sapply(TEST, max)]),
              inherit.aes=FALSE, alpha=0.3) +
    scale_y_sqrt(expand = c(0,0), limits = c(0,NA))
```


### Seasonality

```{r CHILIdat}
CHILIdat <- within(fortify(CHILI), {
    Year = as.factor(strftime(Index, "%Y"))
    DayInYear = as.integer(strftime(Index, "%j"))
    WeekInYear = as.integer(strftime(Index, "%V"))
})
```

```{r seasonality}
## ggplot(CHILIdat, aes(x = DayInYear, y = CHILI, col = Year)) + geom_line()
ggplot(CHILIdat, aes(x = WeekInYear, y = CHILI, col = Year)) + geom_line() +
    scale_y_sqrt(expand = c(0,0), limits = c(0,NA)) +
    guides(col = guide_legend(ncol = 2)) #+ theme(legend.position = "bottom")
```


## Modelling

```{r}
## in the following we use the first forecast period for illustration
TRAIN <- TRAIN[[1]]
TEST <- TEST[[1]]
```


### `surveillance::hhh4`

```{r}
library("surveillance")
CHILI.sts <- sts(observed = CHILI,
                 epoch = as.integer(index(CHILI)), epochAsDate = TRUE)
```

```{r hhh4fit}
(weeksInYear <- table(year(CHILI.sts)))
mean(weeksInYear)  # long-term average is 52.1775
f1 <- addSeason2formula(~ 1, period = 52.1775, timevar = "index")
## equivalent: f1 <- addSeason2formula(~ 1, period = 365.2425, timevar = "t")
hhh4fit <- hhh4(stsObj = CHILI.sts,
     control = list(
         ar = list(f = update(f1, ~. + christmas)),
         end = list(f = f1),
         family = "NegBin1", subset = TRAIN[-1],
         data = list(index = 1:nrow(CHILI.sts),
                     christmas = as.integer(epochInYear(CHILI.sts) %in% 52))
     ))
summary(hhh4fit, maxEV = TRUE)
```

Alternatively, use a yearly varying frequency of 52 or 53 weeks for
the sinusoidal time effects:

```{r hhh4fit_varfreq}
f1_varfreq <- ~ 1 + sin(2*pi*epochInYear/weeksInYear) + cos(2*pi*epochInYear/weeksInYear)
hhh4fit_varfreq <- update(hhh4fit,
    ar = list(f = update(f1_varfreq, ~. + christmas)),
    end = list(f = f1_varfreq),
    data = list(epochInYear = epochInYear(CHILI.sts),
                weeksInYear = rep(weeksInYear, weeksInYear)))
AIC(hhh4fit, hhh4fit_varfreq)
plot(hhh4fit, hhh4fit_varfreq, type = "maxEV",
     matplot.args = list(ylab = expression(lambda[t]), xlim =c(2002,2007)))
```

```{r hhh4fitted_decomposed}
plot(hhh4fit, pch = 20, names = "", ylab = "")
```

```{r hhh4fitted_lambdat}
qplot(x = 1:53, y = predict(hhh4fit, newSubset = 1:53, type="ar.exppred"),
      geom = "line", ylim = c(0,1.3), xlab = "week", ylab = expression(lambda[t])) +
    geom_hline(yintercept = 1, lty = 2)
```

```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$hhh4upper <- CHILIdat$hhh4lower <- CHILIdat$hhh4fitted <- NA_real_
CHILIdat[hhh4fit$control$subset,"hhh4fitted"] <- fitted(hhh4fit)
CHILIdat[hhh4fit$control$subset,c("hhh4lower","hhh4upper")] <-
    sapply(c(0.025, 0.975), function (p)
        qnbinom(p, mu = fitted(hhh4fit),
                size = exp(hhh4fit$coefficients[["-log(overdisp)"]])))
```

```{r hhh4fitted}
ggplot(CHILIdat, aes(x=Index, ymin=hhh4lower, y=hhh4fitted, ymax=hhh4upper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) +
    scale_y_sqrt(expand = c(0,0), limits = c(0,NA))
```


### `forecast::auto.arima`

```{r BoxCox.lambda}
library("forecast")
BoxCox.lambda(CHILI, method = "loglik")  # -> log transformation (lambda = 0)
```

```{r arimafit}
arimafit <- auto.arima(CHILI[TRAIN], lambda = 0, stepwise = FALSE, approximation = FALSE)
summary(arimafit)
```

CAVE: Seasonality cannot be taken into account in the standard way because the
data have no regular frequency (not a standard `"ts"`) ...
But we can add sine/cosine covariates just like in the endemic part of the above
`hhh4` model.

```{r sarimafit}
sarimafit <- auto.arima(CHILI[TRAIN], lambda = 0, stepwise = FALSE, approximation = FALSE,
    xreg = t(sapply(2*pi*TRAIN/52.1775, function (x) c(sin=sin(x), cos=cos(x)))))
summary(sarimafit)
```

```{r sarimaxfit}
sarimax_cov <- cbind(
    t(sapply(2*pi*seq_along(CHILI)/52.1775, function (x) c(sin=sin(x), cos=cos(x)))),
    christmas = as.integer(strftime(index(CHILI), "%V") == "52")
)
sarimaxfit <- auto.arima(CHILI[TRAIN], lambda = 0, stepwise = FALSE, approximation = FALSE,
                         xreg = sarimax_cov[TRAIN,])
summary(sarimaxfit)
```


```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$sarimaxupper <- CHILIdat$sarimaxlower <- CHILIdat$sarimaxfitted <- NA_real_
CHILIdat[TRAIN,"sarimaxfitted"] <- fitted(sarimaxfit)
CHILIdat[TRAIN,c("sarimaxlower","sarimaxupper")] <-
    sapply(c(0.025, 0.975), function (p)
        InvBoxCox(BoxCox(fitted(sarimaxfit), lambda = sarimaxfit$lambda) +
                  qnorm(p, sd=sqrt(sarimaxfit$sigma2)),
                  lambda = sarimaxfit$lambda))
```

```{r sarimaxfitted}
ggplot(CHILIdat, aes(x=Index, ymin=sarimaxlower, y=sarimaxfitted, ymax=sarimaxupper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) +
    scale_y_sqrt(expand = c(0,0), limits = c(0,NA))
```


### `prophet::prophet`

```{r prophetfit}
library("prophet")
prophetfit <- prophet(data.frame(ds = index(CHILI), y = log(CHILI))[TRAIN,],
                      yearly.seasonality = TRUE,
                      weekly.seasonality = FALSE, daily.seasonality = FALSE,
                      holidays = data.frame(
                          holiday = "Christmas",
                          ds = as.Date(paste0(2000:2016, "-12-24")),
                          lower_window = 0,
                          upper_window = 7
                      ))
prophetfitted <- predict(prophetfit)
```

```{r}
## add fitted mean and CI to CHILIdat
CHILIdat$prophetupper <- CHILIdat$prophetlower <- CHILIdat$prophetfitted <- NA_real_
CHILIdat[TRAIN,c("prophetfitted","prophetlower","prophetupper")] <-
    exp(prophetfitted[c("yhat", "yhat_lower", "yhat_upper")])
```

```{r prophetfitted}
##plot(prophetfit, prophetfitted)
ggplot(CHILIdat, aes(x=Index, ymin=prophetlower, y=prophetfitted, ymax=prophetupper)) +
    geom_ribbon(fill="orange") + geom_line(col="darkred") +
    geom_point(aes(y=CHILI), pch=20) +
    scale_y_sqrt(expand = c(0,0), limits = c(0,NA))
```


### kcde? tsiR?



## One-week-ahead forecasts

### `hhh4`

```{r hhh4owa}
stopifnot(packageVersion("surveillance") >= "1.15.0")
hhh4owa <- oneStepAhead(hhh4fit, range(OWA), type = "rolling", verbose = FALSE)
```

```{r hhh4owa_pit}
pit(hhh4owa,
    plot = list(main = "PIT histogram of one-week-ahead forecasts from hhh4"))
```

```{r hhh4owa_caltest, cache = TRUE}
calibrationTest(hhh4owa, which = "dss")
calibrationTest(hhh4owa, which = "logs")
```

```{r hhh4owa_scores}
hhh4owa_scores <- scores(hhh4owa, which = c("dss", "logs"))
summary(hhh4owa_scores)
```

```{r hhh4owa_plot}
par(mar = c(5,5,1,1))
osaplot(
    quantiles = quantile(hhh4owa, probs=1:99/100), probs = 1:99/100,
    observed = CHILI[OWA+1], scores = hhh4owa_scores,
    start = OWA[1]+1, xlab = "Week", ylim = c(0,60000)
)
```


### `Arima`

```{r sarimaxowa, cache = TRUE}
sarimax_order <- sarimaxfit$arma[c(1, 6, 2, 3, 7, 4, 5)]
sarimaxowa <- t(simplify2array(plapply(X = OWA, FUN = function (t) {
    ##cat("t =", t, "...\n")
    sarimaxfit_t <- Arima(CHILI[1:t], lambda = 0,
                          order = sarimax_order[1:3],
                          seasonal = list(order = sarimax_order[4:6], period = sarimax_order[7]),
                          xreg = sarimax_cov[1:t,,drop=FALSE])
    if (t == max(TRAIN)) # check that we are refitting the same model
        stopifnot(identical(fitted(sarimaxfit_t), fitted(sarimaxfit)))
    unlist(predict(sarimaxfit_t, nahead=1, newxreg=sarimax_cov[t+1,,drop=FALSE]))
}, .parallel = 2)))
```

ARIMA forecasts for the log-counts are normal with mean `pred` and variance `se^2`
=> back-transformation via exp() is log-normal

```{r sarimaxowa_pit}
pit(CHILI[OWA+1], pdistr = plnorm, meanlog = sarimaxowa[,"pred"], sdlog = sarimaxowa[,"se"],
    plot = list(main = "PIT histogram of one-week-ahead forecasts from ARIMA"))
```

```{r sarimaxowa_scores}
sarimaxowa_scores <- scores_lnorm(x = CHILI[OWA+1],
                                  meanlog = sarimaxowa[,"pred"],
                                  sdlog = sarimaxowa[,"se"],
                                  which = c("dss", "logs"))
summary(sarimaxowa_scores)
```

```{r sarimaxowa_plot}
sarimaxowa_quantiles <- sapply(X = 1:99/100, FUN = qlnorm,
                               meanlog = sarimaxowa[,"pred"], sdlog = sarimaxowa[,"se"])
osaplot(
    quantiles = sarimaxowa_quantiles, probs = 1:99/100,
    observed = CHILI[OWA+1], scores = sarimaxowa_scores,
    start = OWA[1]+1, xlab = "Week", ylim = c(0,60000)
)
```



### `prophet`



## Long-term forecasts


### `hhh4`



### `Arima`

```{r}
plot(forecast(arimafit, h=length(TEST), fan=TRUE))
##predict(arimafit, n.ahead=length(TEST))
```


### `prophet`

```{r}
##future <- make_future_dataframe(prophetfit, periods = length(TEST), freq = "week", include_history = FALSE)
forecast <- predict(prophetfit, data.frame(ds = index(CHILI)[TEST]))
```
